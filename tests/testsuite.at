AT_INIT
AT_COLOR_TESTS

m4_define([FIND_ZEUGL], [[set -x
if test "$AUTOTEST_PATH" == "$at_testdir"; then
    export PATH="$abs_top_builddir/cli:$PATH"
    zeugl="$abs_top_builddir/cli/zeugl"
    compare="$(dirname "$zeugl")/.libs/lt-zeugl"
else
    export PATH="$AUTOTEST_PATH/cli:$PATH"
    LD_LIBRARY_PATH="$AUTOTEST_PATH/../lib" export LD_LIBRARY_PATH
    zeugl="$AUTOTEST_PATH/zeugl"
    compare="$(zeugl)"
fi]])


AT_SETUP([Test suite sanity check])
AT_CHECK(echo -n Hello Zeugl, 0, Hello Zeugl)
AT_CLEANUP

AT_SETUP([Run shellcheck on all test scripts])
AT_SKIP_IF(! command -v shellcheck)
for file in "$abs_top_builddir/tests/??_test.sh"; do
  AT_CHECK([shellcheck $file])
done
AT_CLEANUP

########################################

AT_SETUP(Create file with mode)
FIND_ZEUGL

# Create file with mode 644
AT_CHECK([zeugl -d -f /dev/null -c 644 testfile.txt], 0, ignore)

# Check that file has mode 644
AT_CHECK([stat testfile.txt --format %a], 0, [644
])

AT_CLEANUP

########################################

AT_SETUP(Existing file mode is kept)
FIND_ZEUGL

# Create an empty file with mode 644
AT_CHECK(install -m 644 /dev/null testfile.txt)

# Create the file with mode 600 if it does not exist
AT_CHECK([zeugl -d -f /dev/null -c 600 testfile.txt], 0, ignore)

# Check that zeugl respected existing file mode
AT_CHECK([stat testfile.txt --format %a], 0, [644
])

AT_CLEANUP

########################################

AT_SETUP(Fail if original file is missing)
FIND_ZEUGL

AT_CHECK([zeugl -df /dev/null testfile.txt], 1, ignore)

AT_CLEANUP

########################################

AT_SETUP(Fail if input file is missing)
FIND_ZEUGL

AT_CHECK([zeugl -d -f no-such-file.txt -c 644 testfile.txt], 1, ignore)

AT_CLEANUP

########################################

AT_SETUP(Expected content from stdin)
FIND_ZEUGL

# Read from stdin
AT_CHECK([echo -n "Hello zeugl" | zeugl -dc 644 testfile.txt], 0, ignore)

# Check expected content
AT_CHECK([cat testfile.txt], 0, [Hello zeugl])

AT_CLEANUP

########################################

AT_SETUP(Expected content from input file)
FIND_ZEUGL

# Create input file
AT_DATA([input.txt], [Hello zeugl
])

# Use zeugl to copy input data into testfile.txt
AT_CHECK([zeugl -df input.txt -c 644 testfile.txt], 0, ignore)

# Check that testfile.txt contains input data
AT_CHECK([cat testfile.txt], 0, [Hello zeugl
])

AT_CLEANUP

########################################

AT_SETUP(File is not truncated by default)
FIND_ZEUGL

# Create input file
AT_DATA([input.txt], [bar
foo 
])

# Create test file
AT_DATA([testfile.txt], [foo
bar
baz
])

# Copy input file to output file without truncation
AT_CHECK([zeugl -df input.txt testfile.txt], 0, ignore)

# Check that output file was not truncated
AT_CHECK([cat testfile.txt], 0, [bar
foo
baz
])

AT_CLEANUP

########################################

AT_SETUP(File is truncated when specified)
FIND_ZEUGL()
AT_CHECK("$abs_top_builddir/tests/10_test.sh", 0, ignore)
AT_CLEANUP

AT_SETUP(Create file with mode when truncated)
FIND_ZEUGL()
AT_CHECK("$abs_top_builddir/tests/11_test.sh", 0, ignore)
AT_CLEANUP

AT_SETUP(Existing file mode is kept when truncated)
FIND_ZEUGL()
AT_CHECK("$abs_top_builddir/tests/12_test.sh", 0, ignore)
AT_CLEANUP

AT_SETUP(File is appended when specified)
FIND_ZEUGL()
AT_CHECK("$abs_top_builddir/tests/13_test.sh", 0, ignore)
AT_CLEANUP

AT_SETUP(Test multithreaded files)
AT_SKIP_IF([! grep -qE "^#define HAVE_PTHREAD 1$" "$abs_top_builddir/config.h"])
AT_CHECK("$abs_top_builddir/tests/test_multithreaded" 8 testfile, 0, ignore)
AT_CLEANUP

AT_SETUP(Check formatting on source files)
AT_SKIP_IF(! command -v clang-format)
for file in "$abs_top_builddir"/**/*.{c,h}; do
    AT_CHECK(clang-format --dry-run --Werror "$file")
done
AT_CLEANUP
